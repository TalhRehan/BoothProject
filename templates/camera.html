{% extends 'base.html' %}

{% block title %}Camera - Sticker Booth{% endblock %}

{% block content %}
<div class="camera-page">
  <!-- Main Camera Interface -->
  <div class="camera-interface">
    <!-- Video Container -->
    <div class="video-container">
      <video id="video"
             autoplay
             playsinline
             muted
             aria-label="Camera preview">
      </video>

      <!-- Countdown Overlay -->
      <div id="overlay" class="overlay" style="display: none;" role="status" aria-live="polite">
        <div id="countdown" class="countdown" aria-label="Countdown">5</div>
      </div>

      <!-- Capture Button -->
      <button id="captureBtn"
              class="capture-fab"
              type="button"
              aria-label="Capture photo">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
          <circle cx="12" cy="13" r="4"/>
        </svg>
        Capture
      </button>
    </div>
    <!-- ðŸ‘‡ camera-status section has been fully removed -->
  </div>

  <!-- Quick Tips Card -->
  <div class="card tips-card mt-8">
    <h3>ðŸ’¡ Quick Tips</h3>
    <div class="tips-grid">
      <div class="tip-item">
        <div class="tip-icon">ðŸ“¸</div>
        <div class="tip-content">
          <strong>Good Lighting</strong>
          <p>Face a window or bright light source for best results</p>
        </div>
      </div>
      <div class="tip-item">
        <div class="tip-icon">ðŸ‘¤</div>
        <div class="tip-content">
          <strong>Center Yourself</strong>
          <p>Keep your face centered in the frame</p>
        </div>
      </div>
      <div class="tip-item">
        <div class="tip-icon">ðŸ˜Š</div>
        <div class="tip-content">
          <strong>Smile!</strong>
          <p>Express yourself - the AI works better with clear expressions</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Professional Settings Modal -->
<dialog id="settingsModal" class="modal" role="dialog" aria-labelledby="settingsTitle" aria-modal="true">
  <form method="dialog">
    <div class="modal-header">
      <h3 id="settingsTitle">Camera Settings</h3>
      <p class="modal-subtitle">Adjust your camera preferences for the best experience</p>
    </div>

    <div class="modal-body">
      <div class="form-group">
        <label for="cameraSelect" class="form-label">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
            <circle cx="12" cy="13" r="4"/>
          </svg>
          Camera Device
        </label>
        <select id="cameraSelect" class="form-select" aria-describedby="cameraHelp">
          <option value="">Loading cameras...</option>
        </select>
        <p id="cameraHelp" class="form-help">Choose which camera to use for capturing photos</p>
      </div>

      <div class="form-group">
        <label for="qualitySelect" class="form-label">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
            <circle cx="9" cy="9" r="2"/>
            <path d="M21 15l-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/>
          </svg>
          Video Quality
        </label>
        <select id="qualitySelect" class="form-select" aria-describedby="qualityHelp">
          <option value="720p">HD (720p) - Recommended</option>
          <option value="1080p">Full HD (1080p) - Best Quality</option>
          <option value="480p">SD (480p) - Faster</option>
        </select>
        <p id="qualityHelp" class="form-help">Higher quality may be slower on some devices</p>
      </div>
    </div>

    <div class="modal-actions">
      <button type="button" value="cancel" class="btn btn-ghost" data-action="cancel">
        Cancel
      </button>
      <button type="button" id="applySettings" value="apply" class="btn btn-primary" data-action="apply">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <polyline points="20,6 9,17 4,12"/>
        </svg>
        Apply Settings
      </button>
    </div>
  </form>
</dialog>

<!-- Hidden Elements -->
<canvas id="captureCanvas"
        width="1280"
        height="960"
        hidden
        aria-hidden="true">
</canvas>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/camera.js') }}?v={{ cache_bust_version | default('2024') }}" defer></script>

<!-- Camera Page Script -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  'use strict';

  // Settings modal management
  const settingsModal = document.getElementById('settingsModal');
  const settingsBtn = document.getElementById('settingsBtn');

  if (settingsBtn && settingsModal) {
    settingsBtn.addEventListener('click', () => {
      settingsModal.showModal();
      const firstInput = settingsModal.querySelector('select, input, button');
      if (firstInput) {
        setTimeout(() => firstInput.focus(), 100);
      }
    });
    settingsModal.addEventListener('click', (e) => {
      if (e.target === settingsModal) {
        settingsModal.close();
      }
    });
    const cancelBtn = settingsModal.querySelector('[data-action="cancel"]');
    const applyBtn = settingsModal.querySelector('[data-action="apply"]');
    if (cancelBtn) cancelBtn.addEventListener('click', () => settingsModal.close());
    if (applyBtn) {
      applyBtn.addEventListener('click', () => {
        settingsModal.close();
        if (window.toast) window.toast.success('Camera settings updated successfully!');
      });
    }
  }

  // Capture button vibration feedback
  const captureBtn = document.getElementById('captureBtn');
  if (captureBtn && 'vibrate' in navigator) {
    captureBtn.addEventListener('click', () => navigator.vibrate(50));
  }

  // Keyboard shortcuts
  document.addEventListener('keydown', (e) => {
    if ((e.key === ' ' || e.key === 'Enter') && e.target === document.body) {
      e.preventDefault();
      if (captureBtn && !captureBtn.disabled) captureBtn.click();
    }
    if (e.key === 'Escape') {
      if (settingsModal && settingsModal.open) settingsModal.close();
    }
  });

  // Page visibility handling
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible') {
      if (window.resumeCamera) window.resumeCamera();
    } else {
      if (window.pauseCamera) window.pauseCamera();
    }
  });
});
</script>
{% endblock %}
