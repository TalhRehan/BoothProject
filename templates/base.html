<!doctype html>
<html lang="en">
<head>
    <!-- Metadata & document setup -->
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Sticker Booth</title>

    <!-- Main stylesheet -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}"/>

    <!-- Decorative script-like font (Instagram-inspired) -->
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
</head>
<body>

<!-- ================= NAVBAR ================= -->
<header class="app-header" role="navigation" aria-label="Primary">
    <nav class="app-nav">
        <!-- Left section (currently empty, reserved for future items) -->
        <div class="nav-left" aria-hidden="true"></div>

        <!-- Centered brand / logo -->
        <div class="nav-center">
            <a class="brand" href="{{ url_for('camera') }}" aria-label="Sticker Booth">
                <span class="brand-text" data-i18n="brand.title">Sticker Booth</span>
            </a>
        </div>

        <!-- Right-side actions (theme toggle, settings, custom header actions) -->
        <div class="nav-right">

            <!-- Theme toggle button -->
            <button id="themeToggle" class="icon-btn" aria-pressed="false" aria-label="Toggle theme"
                    title="Toggle theme">
                <img id="themeIcon" alt="Theme" src="{{ url_for('static', filename='img/dark_mode.png') }}">
            </button>

            <!-- Settings button (theme-aware icon) -->
            <button id="settingsBtn" class="icon-btn" aria-label="Settings" title="Settings">
                <img id="settingsIcon" alt="Settings"
                     src="{{ url_for('static', filename='img/darkThemeSettings.png') }}">
            </button>

            <!-- Extra actions injected per page -->
            <div class="header-actions">
                {% block header_actions %}{% endblock %}
            </div>
        </div>
    </nav>
</header>

<!-- ================= MAIN CONTENT ================= -->
<main class="app-main container">
    {% block content %}{% endblock %}
</main>

<!-- Toast notifications container -->
<div id="toastHost" aria-live="polite" aria-atomic="true"></div>

<!-- ================= SETTINGS MODAL ================= -->
<dialog id="settingsModal" class="modal" role="dialog" aria-labelledby="settingsTitle" aria-modal="true">
    <form method="dialog">
        <!-- Modal header -->
        <div class="modal-header">
            <h3 id="settingsTitle" data-i18n="settings.title">Camera Settings</h3>
        </div>

        <!-- Modal body with form controls -->
        <div class="modal-body">
            <!-- Camera device selector -->
            <div class="form-group">
                <label for="cameraSelect" class="form-label" data-i18n="settings.cameraDevice">
                    <!-- Camera icon (SVG) -->
                    <svg width="16" height="16" ... aria-hidden="true">
                        <path d="M23 19a2 2 0 0 1-2 2H3..."/>
                        <circle cx="12" cy="13" r="4"/>
                    </svg>
                    Camera Device
                </label>
                <select id="cameraSelect" class="form-select" aria-describedby="cameraHelp">
                    <option value="">Loading cameras...</option>
                </select>
                <p id="cameraHelp" class="form-help" data-i18n="settings.cameraHelp">
                    Choose which camera to use for capturing photos
                </p>
            </div>

            <!-- Video quality selector -->
            <div class="form-group">
                <label for="qualitySelect" class="form-label" data-i18n="settings.videoQuality">
                    <!-- Video icon (SVG) -->
                    <svg width="16" height="16" ... aria-hidden="true">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                        <circle cx="9" cy="9" r="2"/>
                        <path d="M21 15l-3.086-3.086..."/>
                    </svg>
                    Video Quality
                </label>
                <select id="qualitySelect" class="form-select" aria-describedby="qualityHelp">
                    <option value="720p" data-i18n="quality.hd720">HD (720p) - Recommended</option>
                    <option value="1080p" data-i18n="quality.fhd1080">Full HD (1080p) - Best Quality</option>
                    <option value="480p" data-i18n="quality.sd480">SD (480p) - Faster</option>
                </select>
                <p id="qualityHelp" class="form-help" data-i18n="settings.qualityHelp">
                    Higher quality may be slower on some devices
                </p>
            </div>

            <!-- Language selector -->
            <div class="form-group">
                <label for="languageSelect" class="form-label">
                    <svg width="16" height="16" ... aria-hidden="true">
                        <path d="M5 8l6 6 6-6"/>
                    </svg>
                    <span data-i18n="settings.language">Language</span>
                </label>
                <select id="languageSelect" class="form-select" aria-describedby="languageHelp">
                    <option value="en" data-i18n="settings.english">English</option>
                    <option value="ar" data-i18n="settings.arabic">العربية</option>
                </select>
            </div>
        </div>

        <!-- Modal actions -->
        <div class="modal-actions">
            <button type="button" value="cancel" class="btn btn-ghost"
                    data-action="cancel" data-i18n="common.cancel">
                Cancel
            </button>
            <button type="button" id="applySettings" value="apply" class="btn btn-primary"
                    data-action="apply" data-i18n="common.applySettings">
                <!-- Checkmark icon -->
                <svg width="16" height="16" ... aria-hidden="true">
                    <polyline points="20,6 9,17 4,12"/>
                </svg>
                Apply Settings
            </button>
        </div>
    </form>
</dialog>

<!-- ================= SCRIPTS ================= -->

<!-- Theme initialization and toggle logic -->
<script>
    (function(){
      const root = document.documentElement;
      const STORAGE_KEY = 'theme';
      const btn = document.getElementById('themeToggle');
      const iconImg = document.getElementById('themeIcon');
      const settingsImg = document.getElementById('settingsIcon');

      // Icon paths for light/dark modes
      const LIGHT_ICON = "{{ url_for('static', filename='img/light_mode.png') }}";
      const DARK_ICON  = "{{ url_for('static', filename='img/dark_mode.png') }}";
      const LIGHT_SETTINGS = "{{ url_for('static', filename='img/lightThemeSettings.png') }}";
      const DARK_SETTINGS  = "{{ url_for('static', filename='img/darkThemeSettings.png') }}";

      // Helper to update icons
      function setIcons(theme) {
        iconImg.src = theme === 'light' ? LIGHT_ICON : DARK_ICON;
        settingsImg.src = theme === 'light' ? LIGHT_SETTINGS : DARK_SETTINGS;
      }

      // Apply theme
      function apply(theme) {
        root.setAttribute('data-theme', theme);
        setIcons(theme);
        btn?.setAttribute('aria-pressed', String(theme === 'dark'));
        try { localStorage.setItem(STORAGE_KEY, theme); } catch {}
      }

      // Initialize theme (localStorage or system preference)
      let theme = 'dark';
      try {
        theme = localStorage.getItem(STORAGE_KEY) ||
                (window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark');
      } catch {}
      apply(theme);

      // Toggle theme on button click
      btn?.addEventListener('click', () => {
        apply(root.getAttribute('data-theme') === 'dark' ? 'light' : 'dark');
      });
    })();
</script>

<!-- Settings modal behavior -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
      const settingsBtn = document.getElementById('settingsBtn');
      const settingsModal = document.getElementById('settingsModal');
      if (!settingsBtn || !settingsModal || !settingsModal.showModal) return;

      // Open modal on button click
      settingsBtn.addEventListener('click', () => {
        settingsModal.showModal();
        const firstInput = settingsModal.querySelector('select, input, button');
        if (firstInput) setTimeout(() => firstInput.focus(), 100);
      });

      // Close modal when clicking backdrop
      settingsModal.addEventListener('click', (e) => {
        if (e.target === settingsModal) settingsModal.close();
      });

      // Wire cancel/apply buttons
      const cancelBtn = settingsModal.querySelector('[data-action="cancel"]');
      const applyBtn  = settingsModal.querySelector('[data-action="apply"]');
      cancelBtn?.addEventListener('click', () => settingsModal.close());
      applyBtn?.addEventListener('click', () => {
        settingsModal.close();
        if (window.toast) window.toast.success('Camera settings updated successfully!');
      });

      // Allow ESC key to close modal
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && settingsModal.open) settingsModal.close();
      });
    });
</script>

<!-- Language preference setup -->
<script>
    (function(){
      const lang = localStorage.getItem('preferred_language') || 'en';
      if (lang === 'ar') {
        document.documentElement.setAttribute('lang', 'ar');
        document.documentElement.classList.add('rtl-loading');
        document.body.style.fontFamily = 'Tajawal, Cairo, "Noto Sans Arabic", Arial, sans-serif';
      }
    })();
</script>

<!-- Internationalization (i18n) system -->
<script src="{{ url_for('static', filename='js/i18n.js') }}?v={{ cache_bust_version | default('2024') }}"
        defer></script>

<!-- Page-specific scripts injected here -->
{% block scripts %}{% endblock %}
</body>
</html>
